name: Deploy with validation on feature push


on:
    push:
        branches:
        - 'force-app/**'     
jobs:
    build:
        runs-on: ubuntu-latest
        steps:
        - uses: actions/checkout@v2
        - name: 'Install Salesforce CLI'
          run: |
              wget https://developer.salesforce.com/media/salesforce-cli/sfdx/channels/stable/sfdx-linux-x64.tar.xz
              mkdir ~/sfdx
              tar xJf sfdx-linux-x64.tar.xz -C ~/sfdx --strip-components 1
              echo "$HOME/sfdx/bin" >> $GITHUB_PATH
              ~/sfdx/bin/sfdx version 

        - name: 'Populate auth file with SFDX_URL secret of development and staging orgs'
          shell: bash
          run: |
              echo ${{ secrets.YOURPLACESPROD}} > ./SFDX_DEVELOPMENT_URL.txt

        - name: 'Authenticate to development org'
          run: sfdx auth:sfdxurl:store -f ./SFDX_DEVELOPMENT_URL.txt -s -a development

        - name: 'Deploying to development org(s) - run specified tests in PR'
          if: ${{ env.APEX_TESTS != 'all' }}
          run: |
              echo ${{env.APEX_TESTS}}
              sfdx force:source:deploy -p "changed-sources/force-app" --testlevel RunSpecifiedTests --runtests ${{env.APEX_TESTS}} --json
        # If the env variable equals all, we run all tests
        - name: 'Deploying to development org(s) - run all tests in repo'
          if: ${{ env.APEX_TESTS == 'all' }}
          run: |
              echo ${{env.APEX_TESTS_ALL}}
              sfdx force:source:deploy -p "changed-sources/force-app" --testlevel RunSpecifiedTests --runtests ${{env.APEX_TESTS_ALL}} --json
        - name: 'Deploy destructive changes (if any)'
          run: sfdx force:mdapi:deploy -d "changed-sources/destructiveChanges" --checkonly --ignorewarnings 
